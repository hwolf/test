name: 'Deploy Pull Request'

on:
  issue_comment:
    types:
     - created

jobs:
  setup:
    name: Setup
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/deploy') && github.event.issue.state == 'open'
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.getref.outputs.head_ref }}
      sha: ${{ steps.getref.outputs.head_sha }}
    steps:
      - uses: xt0rted/pull-request-comment-branch@v3
        id: getref
      - run: |
          echo "head_ref=${{ steps.getref.outputs.head_ref }}" >> $GITHUB_OUTPUT
      - uses: rsotnychenko/deployment-status-update@0.2.1
        with:
          run_id: ${{ github.run_id }}
          status: in_progress
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: 'Build Pull Request'
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/deploy') && github.event.issue.state == 'open'
    needs:
      - setup
    uses: hwolf/workflows/.github/workflows/build-and-test.yml@main
    with:
      ref: "${{ needs.setup.outputs.ref }}"
      revision: "pr-${{ github.event.issue.number }}-${{ github.run_number }}"
      publish-image: true

  deploy:
    name: 'Deploy Pull Request'
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/deploy') && github.event.issue.state == 'open'
    needs:
      - build
      - setup
    uses: hwolf/workflows/.github/workflows/deploy.yml@main
    with:
      image-name: "${{ needs.build.outputs.image-name }}"
      environment: "${{ contains(github.event.comment.body, '/deploy dev') && 'DEV' || 'TEST' }}"
      ref: "${{ needs.setup.outputs.ref }}"

  finished:
    name: 'XXXX'
    runs-on: ubuntu-latest
    if: always()
    needs:
      - setup
      - deploy
    steps:
      - uses: rsotnychenko/deployment-status-update@0.2.1
        with:
          status: ${{ job.status }}
          run_id: ${{ github.run_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Build Branch
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options:
          - none
          - dev
          - test
          - qa
        default: qa
        description: Deploy to environment?

env:
  REVISION: "$(date "+%Y%m%d)-${{ github.run_number }}"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "XXX: $REVISION"
  build:
    name: 'Build'
    if: github.ref == 'refs/heads/main'
    uses: hwolf/test/.github/workflows/build-and-test.yml@test-1
    with:
      revision: $REVISION

  deploy:
    name: 'Deploy'
    if: github.ref == 'refs/heads/main' && inputs.environment != 'none'
    needs:
      - build
    uses: hwolf/test/.github/workflows/deploy.yml@test-1
    with:
      image-name: "${{ needs.build.outputs.image-name }}"
      environment: "${{ inputs.environment || 'qa' }}"
